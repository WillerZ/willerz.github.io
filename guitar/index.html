<!DOCTYPE html>
<html>
    <head>
        <title>Guitar</title>
    </head>
    <body>
        <div id="output3mf"><input id="calculateButton" type="button" value="Calculate"></input></div>
        <script language="javascript" src="https://unpkg.com/@jscad/modeling"></script>
        <!-- <script language="javascript" src="https://unpkg.com/@jscad/3mf-deserializer"></script> -->
        <!-- <script language="javascript" src="https://unpkg.com/@jscad/3mf-serializer"></script> -->
        <script type="module">
            // import * as jscadModeling from "https://unpkg.com/@jscad/modeling";
            // import * as jscad3MFDeserializer from "https://unpkg.com/@jscad/3mf-deserializer";
            // import * as jscad3MFSrializer from "https://unpkg.com/@jscad/3mf-serializer";

            const load3mf = (url) => {
                return new Promise(function (resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", url);
                    xhr.responseType = "blob";
                    xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const geometry = xhr.response;
                        // const geometry = jscad3MFDeserializer.deserialize({output: 'geometry'}, xhr.response);
                        resolve(geometry);
                    } else {
                        reject({
                        status: xhr.status,
                        statusText: xhr.statusText
                        });
                    }
                    };
                    xhr.onerror = function () {
                    reject({
                        status: xhr.status,
                        statusText: xhr.statusText
                    });
                    };
                    xhr.send();
                });
            }

            function calculate() {
                const bodyReq = load3mf("body/batlike.3MF");
                const pickguardReq = load3mf("body/batlike-guard.3MF");
                const controlPlateReq = load3mf("body/batlike-cover.3MF");

                const neckPocketToolReq = load3mf("tool/neck/strat.3MF");
                const neckPickupToolReq = load3mf("tool/pickup/neck/humbucker.3MF");
                const bridgePickupToolReq = load3mf("tool/pickup/bridge/humbucker.3MF");
                const bridgeToolReq = load3mf("tool/bridge/musiclily-ultra.3MF");

                Promise.all([
                    bodyReq,
                    pickguardReq,
                    controlPlateReq,
                    Promise.all([
                        neckPocketToolReq,
                        neckPickupToolReq,
                        bridgePickupToolReq,
                        bridgeToolReq
                    ]),
                ]).then(([body, pickguard, controlPlate, tools]) => {
                    const guitarModel = jscadModeling.booleans.subtract(body, ...tools);
                    const guitarModelBlob = guitarModel; // TODO - serialize once that's supported
                    const pickguardModel = jscadModeling.booleans.subtract(pickguard, ...tools);
                    const pickguardModelBlob = pickguardModel; // TODO - serialize once that's supported
                    const controlPlateModel = jscadModeling.booleans.subtract(controlPlate, ...tools);
                    const controlPlateModelBlob = guitarModel; // TODO - serialize once that's supported
                    document.getElementById("output3mf").innerHTML = '<a download="body.3mf" href="' + URL.createObjectURL(guitarModelBlob) + '">Download the body model</a>, '+ '<a download="pickguard.3mf" href="' + URL.createObjectURL(pickguardModelBlob) + '">Download the pickguard model</a>, and ' + '<a download="controlPlate.3mf" href="' + URL.createObjectURL(controlPlateModelBlob) + '">Download the control plate model</a>, ';
                }).catch(err => {
                    document.getElementById("output3mf").innerHTML = "Well, that didn't work. Sorry.";
                });
            }

            document.getElementById("calculateButton").addEventListener("click", () => {calculate();});
        </script>
    </body>
</html>